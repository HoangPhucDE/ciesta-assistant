language: vi
recipe: default.v1

pipeline:
  - name: custom_components.vietnamese_preprocessor.VietnameseTextPreprocessor

  - name: WhitespaceTokenizer
    intent_tokenization_flag: true
    intent_split_symbol: "+"

  - name: RegexFeaturizer
    case_sensitive: false
    use_word_boundaries: true

  - name: LexicalSyntacticFeaturizer
    features:
      - [low, title, upper]
      - [BOS, EOS, low, upper, title, digit]
      - [low, title, upper]

  - name: RegexEntityExtractor
    case_sensitive: false
    use_lookup_tables: true
    use_word_boundaries: true
    patterns:
      location: |
        # Main pattern for locations with all variants
        (?xi)
        # Optional prefix patterns
        (?:
          (?:th(?:àn|án)h?\s*ph(?:ố|o)|
          t\.?p\.?|
          t[iỉ]nh|
          tỉnh\s+th(?:àn|án)h|
          khu\s+vực)
          \s*
        )?
        # Main location names with variants
        (?:
          # Hồ Chí Minh and variants
          (?:
            h(?:ồ|o)\s*ch(?:í|i)\s*minh|
            h\.?\s*c\.?\s*m\.?|
            s(?:ài|ai)\s*g(?:òn|on)|
            tp\.?\s*h(?:ồ|o)\s*ch(?:í|i)\s*minh|
            tp\.?\s*hcm
          )|
          # Hà Nội and variants
          (?:
            h(?:à|a)\s*n(?:ộ|o)i|
            hn
          )|
          # Đà Nẵng and variants
          (?:
            đ(?:à|a)\s*n(?:ẵ|ă)ng|
            đn
          )|
          # Huế and variants
          (?:
            (?:th(?:ừ|u)a\s*thi(?:ê|e)n\s*)?hu(?:ế|e)
          )|
          # Cần Thơ and variants
          (?:
            c(?:ầ|a)n\s*th(?:ơ|o)
          )|
          # Hải Phòng and variants
          (?:
            h(?:ả|a)i\s*ph(?:ò|o)ng|
            hp
          )|
          # Other major cities
          (?:
            (?:nha\s*trang|kh(?:á|a)nh\s*h(?:ò|o)a)|
            (?:đ(?:à|a)\s*l(?:ạ|a)t|l(?:â|a)m\s*đ(?:ồ|o)ng)|
            (?:v(?:ũ|u)ng\s*t(?:à|a)u|b(?:à|a)\s*r(?:ị|i)a)|
            (?:quy\s*nh(?:ơ|o)n|b(?:ì|i)nh\s*đ(?:ị|i)nh)|
            (?:bu(?:ô|o)n\s*ma\s*thu(?:ộ|o)t|đ(?:ắ|a)k\s*l(?:ắ|a)k)|
            (?:h(?:ạ|a)\s*long|qu(?:ả|a)ng\s*ninh)|
            (?:phan\s*thi(?:ế|e)t|b(?:ì|i)nh\s*thu(?:ậ|a)n)|
            s(?:ơ|o)n\s*la|
            (?:vinh|ngh(?:ệ|e)\s*an)|
            (?:pleiku|gia\s*lai)|
            h(?:à|a)\s*giang|
            b(?:ì|i)nh\s*d(?:ươ|uo)ng
          )
        )
        # Optional suffix patterns
        (?:
          \s+
          (?:
            city|
            province|
            t[iỉ]nh|
            th(?:àn|án)h\s*ph(?:ố|o)
          )?
        )?

  - name: custom_components.phobert_featurizer.PhoBERTFeaturizer
    model_name: "vinai/phobert-large"
    cache_dir: "models_hub/phobert_cache"
    max_length: 256
    pooling_strategy: "mean_max"

  - name: DIETClassifier
    epochs: 500  # Tăng số epochs
    constrain_similarities: true
    learning_rate: 0.0003  # Giảm learning rate để ổn định hơn
    batch_size: [16, 32]  # Giảm batch size để cập nhật thường xuyên hơn
    entity_recognition: true
    intent_classification: true
    confidence_threshold: 0.60  # Giảm ngưỡng confidence
    
    # Tăng cường đánh giá và validation
    evaluate_every_number_of_epochs: 5
    evaluate_on_number_of_examples: 300
    
    # Cải thiện regularization
    regularization_constant: 0.0005
    dropout_rate: 0.35
    
    # Tăng model capacity
    embedding_dimension: 2048  # Khớp với PhoBERT-large mean_max pooling (1024*2)
    number_of_transformer_layers: 6
    transformer_size: 768
    
    # Data augmentation và sampling
    weight_sparsity: 0.7
    negative_samples_factor: 3.0  # Tăng negative samples
    
    # Loss functions
    intent_classification_loss_type: "softmax"  # Softmax loss (tương thích với inner similarity)
    entity_recognition_loss_type: "softmax"  # Softmax loss (tương thích với inner similarity)
    use_masked_language_model: true
    
    # Model improvements
    similarity_type: "inner"  # Inner product (tương thích với softmax)
    model_confidence: "softmax"  # Softmax confidence (yêu cầu similarity_type=inner)
    
    # Entity recognition improvements
    entity_recognition_loss_scale: 2.0
    
    # Extra features
    share_hidden_layers: false  # Tách hidden layers cho intent và entity

  - name: FallbackClassifier
    threshold: 0.55
    ambiguity_threshold: 0.12
    entity_recognition_loss_scale: 2.5
    negative_samples_factor: 2.5
    dropout_rate: 0.25
    regularization_constant: 0.001

  - name: EntitySynonymMapper
    case_sensitive: false
    use_regex: true

policies:
  - name: MemoizationPolicy
  - name: RulePolicy
    core_fallback_action_name: "action_default_fallback"
  - name: UnexpecTEDIntentPolicy
    max_history: 5
    epochs: 100
  - name: TEDPolicy
    max_history: 5
    epochs: 100
    constrain_similarities: true

assistant_id: 20251013-013143-few-run
