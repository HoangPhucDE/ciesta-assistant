# FILE: actions/actions.py

import json
import os
import unicodedata
from typing import Any, Text, Dict, List

from rasa_sdk import Action, Tracker
from rasa_sdk.executor import CollectingDispatcher
from rasa_sdk.events import SlotSet

# --- HÃ m há»— trá»£ chuáº©n hÃ³a tÃªn file ---
def normalize_vietnamese_text(text: Text) -> Text:
    """
    Chuáº©n hÃ³a vÄƒn báº£n tiáº¿ng Viá»‡t Ä‘á»ƒ táº¡o tÃªn file.
    VÃ­ dá»¥: "HÃ  Ná»™i" -> "ha_noi", "CÃ  Mau" -> "ca_mau"
    """
    if not text:
        return ""
    # Chuyá»ƒn thÃ nh dáº¡ng khÃ´ng dáº¥u
    no_accent_text = "".join(
        c for c in unicodedata.normalize("NFD", text) 
        if unicodedata.category(c) != "Mn"
    )
    # Xá»­ lÃ½ chá»¯ "Ä"
    no_accent_text = no_accent_text.replace("Ä", "D").replace("Ä‘", "d")
    # Thay tháº¿ khoáº£ng tráº¯ng báº±ng gáº¡ch dÆ°á»›i vÃ  chuyá»ƒn thÃ nh chá»¯ thÆ°á»ng
    return no_accent_text.replace(" ", "_").lower()

# --- Action chÃ­nh Ä‘á»ƒ tra cá»©u vÃ  tráº£ lá»i ---
class ActionQueryKnowledgeBase(Action):

    def name(self) -> Text:
        return "action_query_knowledge_base"

    def run(self, dispatcher: CollectingDispatcher,
            tracker: Tracker,
            domain: Dict[Text, Any]) -> List[Dict[Text, Any]]:

        # Láº¥y thÃ´ng tin tá»« slot
        location = tracker.get_slot("location")
        requested_info = tracker.get_slot("requested_info")

        # Náº¿u khÃ´ng cÃ³ Ä‘á»‹a Ä‘iá»ƒm, yÃªu cáº§u ngÆ°á»i dÃ¹ng cung cáº¥p
        if not location:
            dispatcher.utter_message(response="utter_ask_for_location")
            return []

        try:
            # XÃ¢y dá»±ng Ä‘Æ°á»ng dáº«n file dá»±a trÃªn tÃªn Ä‘á»‹a Ä‘iá»ƒm Ä‘Ã£ chuáº©n hÃ³a
            normalized_location = normalize_vietnamese_text(location)
            file_path = os.path.join("data", "knowledge_base", "provinces", f"{normalized_location}.json")

            with open(file_path, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            # TÃ¬m Ä‘Ãºng data cá»§a tá»‰nh trong file JSON
            province_data = None
            for key in data:
                if normalize_vietnamese_text(key) == normalized_location:
                    province_data = data[key]
                    break
            
            if not province_data:
                dispatcher.utter_message(text=f"Xin lá»—i, tÃ´i chÆ°a cÃ³ dá»¯ liá»‡u chi tiáº¿t cho '{location}'.")
                return [SlotSet("location", None), SlotSet("requested_info", None)]

            # XÃ¢y dá»±ng cÃ¢u tráº£ lá»i dá»±a trÃªn yÃªu cáº§u
            response_title = ""
            response_body = ""

            if requested_info == "places_to_visit":
                response_title = f"ğŸï¸ **CÃ¡c Ä‘á»‹a Ä‘iá»ƒm khÃ´ng thá»ƒ bá» lá»¡ táº¡i {location}:**\n\n"
                places = province_data.get("places_to_visit", [])
                if places:
                    for item in places[:5]:  # Giá»›i háº¡n 5 Ä‘á»‹a Ä‘iá»ƒm
                        name = item.get("name", "N/A")
                        details = item.get("details", "")
                        response_body += f"ğŸ“ **{name}**\n{details}\n\n"
                else:
                    response_body = "Hiá»‡n chÆ°a cÃ³ thÃ´ng tin chi tiáº¿t vá» Ä‘á»‹a Ä‘iá»ƒm tham quan."
            
            elif requested_info == "what_to_eat":
                response_title = f"ğŸœ **Äáº·c sáº£n áº©m thá»±c táº¡i {location}:**\n\n"
                foods = province_data.get("what_to_eat", [])
                if foods:
                    for item in foods[:5]:
                        name = item.get("name", "N/A")
                        details = item.get("details", "")
                        response_body += f"ğŸ½ï¸ **{name}**\n{details}\n\n"
                else:
                    response_body = "Hiá»‡n chÆ°a cÃ³ thÃ´ng tin vá» Ä‘áº·c sáº£n áº©m thá»±c."
            
            elif requested_info == "festivals":
                response_title = f"ğŸŠ **CÃ¡c lá»… há»™i Ä‘áº·c sáº¯c táº¡i {location}:**\n\n"
                festivals = province_data.get("festivals", [])
                if festivals:
                    for item in festivals:
                        name = item.get("name", "N/A")
                        time = item.get("time", "")
                        details = item.get("details", "")
                        response_body += f"ğŸ‰ **{name}**\nâ° Thá»i gian: {time}\n{details}\n\n"
                else:
                    response_body = "Hiá»‡n chÆ°a cÃ³ thÃ´ng tin vá» lá»… há»™i."
            
            else:  # TrÆ°á»ng há»£p "general" hoáº·c há»i chung
                response_title = f"ğŸ“ **ThÃ´ng tin vá» {location}:**\n\n"
                culture = province_data.get("culture_details", "")
                response_body += f"{culture}\n\n"
                
                # ThÃªm gá»£i Ã½
                response_body += "ğŸ’¡ Báº¡n cÃ³ thá»ƒ há»i tÃ´i vá»:\n"
                response_body += "â€¢ Äá»‹a Ä‘iá»ƒm tham quan\n"
                response_body += "â€¢ Äáº·c sáº£n áº©m thá»±c\n"
                response_body += "â€¢ Lá»… há»™i vÄƒn hÃ³a\n"

            # Gá»­i cÃ¢u tráº£ lá»i
            full_response = response_title + response_body
            dispatcher.utter_message(text=full_response)

        except FileNotFoundError:
            dispatcher.utter_message(
                text=f"Xin lá»—i, tÃ´i chÆ°a cÃ³ thÃ´ng tin chi tiáº¿t vá» '{location}'. "
                     f"Hiá»‡n tÃ´i cÃ³ dá»¯ liá»‡u vá» 34 tá»‰nh thÃ nh Viá»‡t Nam. Báº¡n cÃ³ thá»ƒ thá»­ há»i vá» tá»‰nh khÃ¡c!"
            )
        
        except Exception as e:
            print(f"âŒ Lá»—i: {e}")
            dispatcher.utter_message(text="Ráº¥t tiáº¿c, Ä‘Ã£ cÃ³ lá»—i xáº£y ra khi tÃ´i tÃ¬m kiáº¿m thÃ´ng tin.")

        # XÃ³a slot sau khi tráº£ lá»i
        return [SlotSet("location", None), SlotSet("requested_info", None)]